import styled from '@emotion/styled';
import colors from 'web-check-live/styles/colors';
import { Card } from 'web-check-live/components/Form/Card';
import Row from 'web-check-live/components/Form/Row';

const cardStyles = `
  max-height: 100rem;
  overflow-y: auto;
  grid-row: span 2;
`;

const WarningBanner = styled.div`
  background: ${colors.warning};
  color: #000;
  padding: 0.75rem;
  border-radius: 8px;
  margin-bottom: 1rem;
  font-size: 0.9rem;

  strong {
    display: block;
    margin-bottom: 0.25rem;
  }
`;

const ErrorBanner = styled.div`
  background: ${colors.danger};
  color: #fff;
  padding: 0.75rem;
  border-radius: 8px;
  margin-bottom: 1rem;

  strong {
    display: block;
    margin-bottom: 0.25rem;
  }

  code {
    background: rgba(0,0,0,0.2);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
  }
`;

const SummaryContainer = styled.div`
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
  padding: 0.75rem;
  background: ${colors.backgroundDarker};
  border-radius: 8px;
`;

const SummaryCircle = styled.div<{ vulnCount: number }>`
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.25rem;
  font-weight: bold;
  background: ${props => {
    if (props.vulnCount === 0) return colors.success;
    if (props.vulnCount <= 2) return colors.warning;
    return colors.danger;
  }};
  color: ${colors.background};
`;

const SummaryLabel = styled.div`
  flex: 1;
  span {
    display: block;
    font-size: 0.85rem;
    color: ${colors.textColorSecondary};
  }
  strong {
    color: ${colors.textColor};
  }
`;

const StatBadges = styled.div`
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
  margin-top: 0.25rem;
`;

const StatBadge = styled.span<{ severity: string }>`
  padding: 0.15rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
  font-weight: bold;
  background: ${props => {
    switch (props.severity) {
      case 'critical': return '#dc3545';
      case 'high': return '#fd7e14';
      case 'medium': return '#ffc107';
      case 'low': return '#17a2b8';
      default: return colors.primary;
    }
  }};
  color: ${props => props.severity === 'medium' ? '#000' : '#fff'};
`;

const Section = styled.details`
  margin: 0.5rem 0;
  border: 1px solid ${colors.primaryTransparent};
  border-radius: 4px;
  padding: 0.5rem;

  summary {
    cursor: pointer;
    font-weight: bold;
    padding: 0.25rem;
    color: ${colors.textColor};

    &::marker {
      color: ${colors.primary};
    }
  }

  &[open] {
    background: ${colors.backgroundDarker};
  }
`;

const VulnerabilityItem = styled.div<{ severity?: string }>`
  padding: 0.5rem;
  margin: 0.5rem 0;
  border-left: 3px solid ${props => {
    switch (props.severity) {
      case 'critical': return '#dc3545';
      case 'high': return '#fd7e14';
      case 'medium': return '#ffc107';
      case 'low': return '#17a2b8';
      default: return colors.primary;
    }
  }};
  background: ${colors.backgroundDarker};
  border-radius: 0 4px 4px 0;

  .title {
    font-weight: bold;
    color: ${colors.textColor};
  }

  .details {
    font-size: 0.85rem;
    color: ${colors.textColorSecondary};
    margin-top: 0.25rem;
  }

  code {
    background: rgba(0,0,0,0.3);
    padding: 0.1rem 0.3rem;
    border-radius: 3px;
    font-size: 0.8rem;
  }
`;

const FileItem = styled.div`
  padding: 0.25rem 0.5rem;
  margin: 0.25rem 0;
  background: ${colors.backgroundDarker};
  border-radius: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;

  .path {
    font-family: monospace;
    color: ${colors.danger};
  }

  .meta {
    font-size: 0.8rem;
    color: ${colors.textColorSecondary};
  }
`;

const TestResult = styled.div`
  padding: 0.25rem 0;
  border-bottom: 1px solid ${colors.primaryTransparent};

  &:last-child {
    border-bottom: none;
  }

  .endpoint {
    font-weight: 500;
  }

  .status {
    font-size: 0.85rem;
  }

  .status.safe {
    color: ${colors.success};
  }

  .status.vulnerable {
    color: ${colors.danger};
  }
`;

const formatBytes = (bytes: number): string => {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
};

const WpPentestCard = (props: { data: any, title: string, actionButtons: any }): JSX.Element => {
  const data = props.data;

  // Handle unauthorized state
  if (data.error === 'Authorization required') {
    return (
      <Card heading={props.title} actionButtons={props.actionButtons}>
        <ErrorBanner>
          <strong>Authorization Required</strong>
          <p>{data.message}</p>
          <p style={{ marginTop: '0.5rem', fontSize: '0.85rem' }}>
            {data.legal}
          </p>
        </ErrorBanner>
        <Row lbl="Status" val="Waiting for authorization" />
        <Row lbl="How to Enable" val="Add ?authorized=true to enable testing" />
      </Card>
    );
  }

  // Handle errors
  if (data.error && !data.authorized) {
    return (
      <Card heading={props.title} actionButtons={props.actionButtons}>
        <ErrorBanner>
          <strong>Test Failed</strong>
          <p>{data.error}</p>
        </ErrorBanner>
      </Card>
    );
  }

  const {
    summary = {},
    sqlInjection = { tested: [], vulnerable: [] },
    xss = { tested: [], vulnerable: [] },
    lfi,
    backupFiles,
    xmlRpcBruteForce,
    knownExploits = [],
  } = data;

  const totalVulns = summary.vulnerabilitiesFound || 0;

  return (
    <Card heading={props.title} styles={cardStyles} actionButtons={props.actionButtons}>
      {/* Warning Banner */}
      <WarningBanner>
        <strong>Active Penetration Test Results</strong>
        This test was performed with authorization. Results are for security improvement purposes only.
        Tested at: {data.timestamp}
      </WarningBanner>

      {/* Summary */}
      <SummaryContainer>
        <SummaryCircle vulnCount={totalVulns}>
          {totalVulns}
        </SummaryCircle>
        <SummaryLabel>
          <strong>Vulnerabilities Found</strong>
          <span>
            {summary.totalTests || 0} tests performed
          </span>
          <StatBadges>
            {summary.criticalCount > 0 && (
              <StatBadge severity="critical">{summary.criticalCount} Critical</StatBadge>
            )}
            {summary.highCount > 0 && (
              <StatBadge severity="high">{summary.highCount} High</StatBadge>
            )}
            {summary.mediumCount > 0 && (
              <StatBadge severity="medium">{summary.mediumCount} Medium</StatBadge>
            )}
            {summary.lowCount > 0 && (
              <StatBadge severity="low">{summary.lowCount} Low</StatBadge>
            )}
            {totalVulns === 0 && (
              <StatBadge severity="low" style={{ background: colors.success }}>All Clear</StatBadge>
            )}
          </StatBadges>
        </SummaryLabel>
      </SummaryContainer>

      {/* SQL Injection Section */}
      <Section open={sqlInjection.vulnerable.length > 0}>
        <summary>
          SQL Injection ({sqlInjection.vulnerable.length > 0 ? `${sqlInjection.vulnerable.length} vulnerable` : 'Safe'})
        </summary>
        {sqlInjection.vulnerable.length > 0 ? (
          sqlInjection.vulnerable.map((vuln: any, i: number) => (
            <VulnerabilityItem key={i} severity="critical">
              <div className="title">{vuln.endpoint}: {vuln.param}</div>
              <div className="details">
                Type: {vuln.type} | Path: <code>{vuln.path}</code>
                <br />
                Payload: <code>{vuln.payload}</code>
                <br />
                {vuln.details}
              </div>
            </VulnerabilityItem>
          ))
        ) : (
          <Row lbl="Status" val="No SQL injection vulnerabilities detected" />
        )}
        {sqlInjection.tested.length > 0 && (
          <details style={{ marginTop: '0.5rem' }}>
            <summary style={{ fontSize: '0.85rem', cursor: 'pointer' }}>Show all {sqlInjection.tested.length} tests</summary>
            {sqlInjection.tested.map((test: any, i: number) => (
              <TestResult key={i}>
                <span className="endpoint">{test.endpoint}</span>
                <span className={`status ${test.vulnerable ? 'vulnerable' : 'safe'}`}>
                  {' '}- {test.vulnerable ? 'VULNERABLE' : 'Safe'}
                </span>
              </TestResult>
            ))}
          </details>
        )}
      </Section>

      {/* XSS Section */}
      <Section open={xss.vulnerable.length > 0}>
        <summary>
          Cross-Site Scripting (XSS) ({xss.vulnerable.length > 0 ? `${xss.vulnerable.length} vulnerable` : 'Safe'})
        </summary>
        {xss.vulnerable.length > 0 ? (
          xss.vulnerable.map((vuln: any, i: number) => (
            <VulnerabilityItem key={i} severity="high">
              <div className="title">{vuln.endpoint}: {vuln.param}</div>
              <div className="details">
                Type: {vuln.type} | Path: <code>{vuln.path}</code>
                <br />
                {vuln.details}
              </div>
            </VulnerabilityItem>
          ))
        ) : (
          <Row lbl="Status" val="No XSS vulnerabilities detected" />
        )}
        {xss.tested.length > 0 && (
          <details style={{ marginTop: '0.5rem' }}>
            <summary style={{ fontSize: '0.85rem', cursor: 'pointer' }}>Show all {xss.tested.length} tests</summary>
            {xss.tested.map((test: any, i: number) => (
              <TestResult key={i}>
                <span className="endpoint">{test.endpoint}</span>
                <span className={`status ${test.vulnerable ? 'vulnerable' : 'safe'}`}>
                  {' '}- {test.vulnerable ? 'VULNERABLE' : 'Safe'}
                </span>
              </TestResult>
            ))}
          </details>
        )}
      </Section>

      {/* LFI Section */}
      <Section open={lfi?.vulnerable}>
        <summary>
          Local File Inclusion (LFI) ({lfi?.vulnerable ? 'VULNERABLE' : 'Safe'})
        </summary>
        {lfi?.vulnerable ? (
          <VulnerabilityItem severity="critical">
            <div className="title">LFI Vulnerability Detected</div>
            <div className="details">
              Endpoint: <code>{lfi.endpoint}</code>
              <br />
              Parameter: <code>{lfi.param}</code>
              <br />
              {lfi.details}
            </div>
          </VulnerabilityItem>
        ) : (
          <Row lbl="Status" val={lfi?.details || 'No LFI vulnerability detected'} />
        )}
      </Section>

      {/* Backup Files Section */}
      <Section open={backupFiles?.vulnerable}>
        <summary>
          Exposed Backup Files ({backupFiles?.exposedFiles?.length > 0
            ? `${backupFiles.exposedFiles.length} found`
            : 'None found'})
        </summary>
        {backupFiles?.exposedFiles?.length > 0 ? (
          <>
            <Row lbl="Scanned Paths" val={backupFiles.scannedPaths} />
            <Row lbl="Files Found" val={backupFiles.exposedFiles.length} />
            {backupFiles.exposedFiles.map((file: any, i: number) => (
              <FileItem key={i}>
                <span className="path">{file.path}</span>
                <span className="meta">
                  <StatBadge severity={file.severity}>{file.severity}</StatBadge>
                  {' '}{formatBytes(file.size)}
                </span>
              </FileItem>
            ))}
          </>
        ) : (
          <Row lbl="Status" val={`Scanned ${backupFiles?.scannedPaths || 0} paths - No exposed backup files found`} />
        )}
      </Section>

      {/* XML-RPC Brute Force Section */}
      <Section open={xmlRpcBruteForce?.vulnerable}>
        <summary>
          XML-RPC Brute Force ({xmlRpcBruteForce?.vulnerable ? 'Vulnerable' : 'Protected'})
        </summary>
        {xmlRpcBruteForce?.vulnerable ? (
          <VulnerabilityItem severity="high">
            <div className="title">XML-RPC Amplification Attack Possible</div>
            <div className="details">
              Method: <code>{xmlRpcBruteForce.method}</code>
              <br />
              {xmlRpcBruteForce.details}
            </div>
          </VulnerabilityItem>
        ) : (
          <Row lbl="Status" val={xmlRpcBruteForce?.details || 'XML-RPC brute force not exploitable'} />
        )}
      </Section>

      {/* Known Exploits Section */}
      <Section open={knownExploits.filter((e: any) => e.vulnerable).length > 0}>
        <summary>
          Known Plugin Exploits ({knownExploits.filter((e: any) => e.vulnerable).length} vulnerable)
        </summary>
        {knownExploits.length === 0 ? (
          <Row lbl="Status" val="No plugin exploits tested" />
        ) : (
          knownExploits.map((exploit: any, i: number) => (
            <VulnerabilityItem
              key={i}
              severity={exploit.vulnerable ? 'critical' : undefined}
              style={!exploit.vulnerable ? { borderLeftColor: colors.success } : undefined}
            >
              <div className="title">
                {exploit.vulnerable ? '!' : '!'} {exploit.plugin} - {exploit.name}
              </div>
              <div className="details">
                CVE: <code>{exploit.cve}</code>
                <br />
                Affected Versions: {exploit.affectedVersion}
                <br />
                Status: {exploit.vulnerable ? (
                  <span style={{ color: colors.danger }}>POTENTIALLY VULNERABLE</span>
                ) : (
                  <span style={{ color: colors.success }}>Not vulnerable</span>
                )}
                <br />
                {exploit.details}
              </div>
            </VulnerabilityItem>
          ))
        )}
      </Section>
    </Card>
  );
};

export default WpPentestCard;
